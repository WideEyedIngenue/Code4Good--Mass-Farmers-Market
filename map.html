<!DOCTYPE html>
<html>
<head>
    <title>Mass Farmers Market Association Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="UTF-8">

    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/dropdownbtn.css">

</head>
<body>

<div class="container">
    <h1>Massachusetts Farmers Market Alliance
        <span class="divider">|</span>
        <span class="sub-headline">
          <span id="station-count"></span> Market Locations
        </span>
    </h1>
    <div class="row align-items-center">
        <div class="btn-group snap_toggles" role="group" aria-label="Coupons">
            <div class="col-md-12">
                <div class="center">
                    <input type="checkbox" id="SNAPEBT" class="toggle_button" onchange=filter(this) style="display:none"/>
                    <label for="SNAPEBT" class="toggle"><span></span>SNAP</label>
                </div>
            </div>

            <div class="col-md-12">
                <div class="center">
                    <input type="checkbox" id="HIP" class="toggle_button" onchange=filter(this) style="display:none"/>
                    <label for="HIP" class="toggle"><span></span>HIP</label>
                </div>
            </div>

            <div class="col-md-12">
                <div class="center">
                    <input type="checkbox" id="SNAPMATCH" class="toggle_button" onchange=filter(this) style="display:none"/>
                    <label for="SNAPMATCH" class="toggle"><span></span>SNAP Match</label>
                </div>
            </div>
            <!--Format for a new Button:
            <input type="checkbox" class="btn btn-secondary" id="name of attribute column" onchange=filter(this)>Button Text</input>
            -->
        </div>
    </div>
</div>


<div class="row align-items-center">
    <div class="btn-group days_toggles" role="group" aria-label="Coupons">
        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Monday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Monday" class="toggle"><span></span>Monday</label>
            </div>
        </div>

        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Tuesday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Tuesday" class="toggle"><span></span>Tuesday</label>
            </div>
        </div>

        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Wednesday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Wednesday" class="toggle"><span></span>Wednesday</label>
            </div>
        </div>

        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Thursday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Thursday" class="toggle"><span></span>Thursday</label>
            </div>
        </div>

        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Friday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Friday" class="toggle"><span></span>Friday</label>
            </div>
        </div>

        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Saturday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Saturday" class="toggle"><span></span>Saturday</label>
            </div>
        </div>

        <div class="col-md-12">
            <div class="center">
                <input type="checkbox" id="Sunday" class="toggle_button" onchange=filter(this) style="display:none"/>
                <label for="Sunday" class="toggle"><span></span>Sunday</label>
            </div>
        </div>
    </div>
</div>

<div class="row align-items-center">
    <div class="col-md-12">
        <div class="dropdown">
            <button class="dropbtn">Dropdown</button>
            <div class="dropdown-content">
                <a onclick=resetMarkers()>All</a>
                <a onclick=distanceFilter(userLocation,1,this)>1 mi</a>
                <a onclick=distanceFilter(userLocation,2,this)>2 mi</a>
                <a onclick=distanceFilter(userLocation,200,this)>5 mi</a>
            </div>
        </div>
    </div>

    <!-- unused buttons
            <div class="col-md-12">
                <div class="btn-group" role="group" aria-label="Products">
                    <button type="checkbox" class="btn btn-secondary" id="dairy" onchange=filter(this)>Dairy</button>
                    <button type="checkbox" class="btn btn-secondary" id="bakedGoods">Baked Goods</button>
                    <button type="checkbox" class="btn btn-secondary" id= "produce"><i class="fas fa-carrot"></i>&nbsp Produce</button>
                </div>
            </div> -->
</div>
<div class="row align-items-center maprow">
    <div class="col-md-12">
        <div id="map"></div>
    </div>
</div>



<script src="papaparse.min.js"></script>
<script>
    function getDistance(lat1, lon1, lat2, lon2, unit) {
        if ((lat1 == lat2) && (lon1 == lon2)) {
            return 0;
        }
        else {
            var radlat1 = Math.PI * lat1/180;
            var radlat2 = Math.PI * lat2/180;
            var theta = lon1-lon2;
            var radtheta = Math.PI * theta/180;
            var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
            if (dist > 1) {
                dist = 1;
            }
            dist = Math.acos(dist);
            dist = dist * 180/Math.PI;
            dist = dist * 60 * 1.1515;
            if (unit=="K") { dist = dist * 1.609344 }
            if (unit=="N") { dist = dist * 0.8684 }
            return dist;
        }
    }

    /**
     * Filters out markers outside a certain radius (in mi)
     * userLat: latitude of user
     * userLon: longitude of user
     * radius: radius of to filter (in mi)
     */
    function distanceFilter(location, radius, selector){
        console.log(selector);
        for (var i = 0; i < markers.length; i++){
            if(getDistance(location.lat, location.lng, data[i].Longitude, data[i].Latitude) > radius){
                console.log(data[i]["Market Name"]);
                console.log(getDistance(location.lat, location.lng, data[i].Longitude, data[i].Latitude, "K"))
                markers[i].setMap(null);
            }
        }
    }
    /**
     * Filters out selected attributes
     */
    function filter(button){
        if (document.getElementById(button.id).checked == false){
            resetMarkers()
        } else {
            for(var i = 0; i < data.length; i++){
                if(data[i][button.id] == 0) {
                    markers[i].setMap(null);
                }
            }
        }
    }
    function resetMarkers(){
        for(var i = 0; i < markers.length; i++){
            markers[i].setMap(map)
        }
    }
</script>






<script>
    var data;
    var markers = []; //Empty array
    var infowindows = [];
    var map;
    var userLocation;
    /**
     * Initializes map with markers and data
     */

    function initMap() {
        var csvFile = 'tweak.csv' //CSV  with farmer's market data
        console.log(csvFile);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                console.log(userLocation)
            });
        } else {
            console.log("No location available.");
        }
        var boston = {lat: 42.359884, lng: -71.058813}; //Location of Boston
        map = new google.maps.Map(
            document.getElementById('map'), {zoom: 8, center: boston}); //Creates map centered on Boston
        Papa.parse(csvFile, { //Gets data from the CSV
            header: true,
            download: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function (results) {
                data = results.data;


                for (var i = 0; i < data.length; i++) {
                    if (data[i].Latitude != 0 && data[i].Longitude != 0) {
                        var location = {lat: data[i].Latitude, lng: data[i].Longitude}; //Gets location of each farmer's market
                        var marker = new google.maps.Marker({position: location, map: map}) //Creates a marker and places it on the map
                        markers.push(marker);
                        //Stores marker in array

                        //info for creating info-window for each marker
                        var name = data[i]["Market Name"];
                        var days = data[i]["Days of Week"];
                        var open_time = data[i]["Open"];
                        var close_time = data[i]["Close"];
                        var start_date = data[i]["Start Date"];
                        var end_date = data[i]["End Date"];
                        //var url = generate_map_url(data[i]["Address"]);

                        var contentString =  '<b>' + name + '</b>' +
                            '<p><u>Dates:</u> ' + start_date + "-" + end_date + '</p>' +
                            '<p><u>Hours:</u> ' + open_time + "-" + close_time + '</p>' +
                            '<p><u>Days Open:</u> ' + days + '</p>'
                        ;

                        var infowindow = new google.maps.InfoWindow ({
                            content : contentString
                        });
                        marker.infowindow = infowindow;
                        google.maps.event.addListener(marker,'mouseover',function() {
                            this.infowindow.open(map,this);


                        });
                        google.maps.event.addListener(marker,'mouseout',function() {
                            this.infowindow.close();
                        });
                        infowindows.push(infowindow);
                    }

                }

            }

        })
    }
    console.log(markers);

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDlg_RXppjqCe1dTW8XW2xBYgmq84-O-xQ&callback=initMap"
        async defer></script>
</body>
</html>
